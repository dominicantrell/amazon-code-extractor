<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>亚马逊礼品卡兑换码提取</title>
  <style>
    body {
      font-family: Arial,sans-serif;
      margin: 40px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    input {
      font-size: 16px;
      padding: 8px;
      width: 60%;
      min-width: 300px;
      margin-right: 10px;
    }
    button {
      font-size: 16px;
      padding: 8px 16px;
      cursor: pointer;
      background-color: #FF9900;
      border: none;
      color: #111;
      border-radius: 3px;
    }
    button:hover {
      background-color: #FFB84D;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
      padding: 10px;
      border-radius: 3px;
    }
    .success {
      color: #006400;
      background-color: #F0FFF0;
      border: 1px solid #90EE90;
    }
    .error {
      color: #D8000C;
      background-color: #FFE6E6;
      border: 1px solid #FFBABA;
    }
    .loading {
      color: #00529B;
      background-color: #F0F8FF;
      border: 1px solid #BDE0FE;
    }
    /* 加载动画 */
    @keyframes ellipsis {
      0% { content: "."; }
      50% { content: ".."; }
      100% { content: "..."; }
    }
    .loading::after {
      content: ".";
      animation: ellipsis 1s infinite;
    }
  </style>
</head>
<body>
  <h2>亚马逊礼品卡兑换码提取工具</h2>
  <input type="text" id="urlInput" placeholder="粘贴亚马逊礼品卡兑换链接（如 https://www.amazon.com/gp/redeem/xxx）">
  <button onclick="extract()">提取兑换码</button>
  <div id="result"></div>

  <script>
    async function extract() {
      const urlInput = document.getElementById('urlInput');
      const resultDiv = document.getElementById('result');
      const url = urlInput.value.trim();

      // 1. 校验输入是否为空
      if (!url) {
        resultDiv.className = "error";
        resultDiv.innerText = "❌ 请输入亚马逊礼品卡兑换链接";
        urlInput.focus();
        return;
      }

      // 2. 校验是否为亚马逊链接
      const isAmazonUrl = url.includes('amazon.com') || url.includes('amzn.com');
      if (!isAmazonUrl) {
        resultDiv.className = "error";
        resultDiv.innerText = "❌ 请输入有效的亚马逊链接（需包含 amazon.com 或 amzn.com）";
        urlInput.select();
        return;
      }

      // 3. 显示加载状态
      resultDiv.className = "loading";
      resultDiv.innerText = "⏳ 正在提取，请稍候";

      try {
        // 4. 发送请求（已修复URL格式）
        const resp = await fetch('http://184.168.28.68:8000/api/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url }),
          // 解决跨域问题（若后端未配置，需添加此参数，开发环境用）
        });

        // 5. 处理响应（兼容后端可能返回的非JSON格式错误）
        let data;
        try {
          data = await resp.json();
        } catch (parseErr) {
          throw new Error("后端返回格式错误，请检查服务是否正常");
        }

        // 6. 显示结果
        if (data.success) {
          resultDiv.className = "success";
          // 增加复制功能，方便用户直接复制兑换码
          resultDiv.innerHTML = `✅ 兑换码：<b id="claimCode">${data.claimCode}</b>
                                <button style="font-size:14px; padding:3px 8px; margin-left:10px;"
                                onclick="copyCode()">复制</button>`;
        } else {
          resultDiv.className = "error";
          resultDiv.innerText = `❌ 提取失败：${data.msg || '未知错误'}`;
        }

      } catch (e) {
        // 7. 捕获网络或其他异常
        resultDiv.className = "error";
        resultDiv.innerText = `❌ 请求失败：${e.message || '请检查后端服务是否在线'}`;
      }
    }

    // 新增：复制兑换码功能
    function copyCode() {
      const codeElement = document.getElementById('claimCode');
      const code = codeElement.innerText;
      navigator.clipboard.writeText(code).then(() => {
        // 复制成功提示
        const resultDiv = document.getElementById('result');
        const originalHtml = resultDiv.innerHTML;
        resultDiv.innerHTML = `✅ 兑换码已复制！<br>${originalHtml}`;
        // 3秒后恢复原内容
        setTimeout(() => {
          resultDiv.innerHTML = originalHtml;
        }, 3000);
      }).catch(() => {
        alert("复制失败，请手动复制兑换码");
      });
    }
  </script>
</body>
</html>